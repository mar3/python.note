#!/usr/bin/env python
# coding: utf-8
#
# OpenLDAP からデータを抽出する
#
#
#
#
#


import sys
import os
import ldap3
import datetime
import time
import json
import codecs



##############################################################################
##############################################################################
##############################################################################
##############################################################################
##############################################################################
##############################################################################
class constants:

	HOST = '192.168.141.129';
	PORT = 389;
	PRINCIPAL = 'cn=Manager,dc=example,dc=jp';
	PASSWORD = 'root';






###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
class out:

	@staticmethod
	def println(*arguments):

		out = codecs.getwriter('utf-8')(sys.stdout)
		for x in arguments:
			if x is None:
				continue
			out.write(x)
		out.write("\n")






###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
class util:

	# "yyyy-mm-dd hh:mm:ss.xxxxxx"
	@staticmethod
	def timestamp():

		x = datetime.datetime.now();
		return x.isoformat(' ');






###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
class stopwatch:

	_value = None

	def __init__(self):

		self._member = datetime.datetime.now()

	def __repr__(self):

		current = datetime.datetime.now()
		elapsed = current - self._member
		return str(elapsed)






###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
class logger:

	@staticmethod
	def error(*arguments):

		out.println(util.timestamp(), ' [error] ', *arguments)

	@staticmethod
	def info(*arguments):

		out.println(util.timestamp(), ' [info] ', *arguments)

	@staticmethod
	def debug(*arguments):

		out.println(util.timestamp(), ' [debug] ', *arguments)






###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
class test:

	@staticmethod
	def test():

		server_info = ldap3.Server(
				constants.HOST,
				port = constants.PORT)

		session = ldap3.Connection(
				server_info,
				auto_bind = True,
				client_strategy = ldap3.STRATEGY_SYNC,
				user = constants.PRINCIPAL,
				password = constants.PASSWORD)

		handle = session.search(
				'ou=People,dc=example,dc=jp',
				'(objectClass=*)',
				ldap3.SEARCH_SCOPE_WHOLE_SUBTREE,
				attributes = [ '*', '+' ])

		entries_affected = 0
		for entry in session.response:
			logger.info('detected: ', json.dumps(entry, indent=4))
			entries_affected += 1

		session.unbind()

		logger.info(str(entries_affected), u'件のエントリーを検出')






###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
class main:

	@staticmethod
	def main():

		watch = stopwatch()
		logger.info(u'### start ###')
		test.test()
		logger.info(u'処理時間=[', str(watch), ']')
		logger.info(u'--- end ---')

main.main();

